<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gestão - Delivery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@500;700&family=Poppins:wght@300;400;600&family=Bebas+Neue&family=Anton&family=Oswald&family=Roboto&family=Lato&family=Montserrat&family=Playfair+Display&family=Lobster&family=Alfa+Slab+One&family=Patua+One&family=Merriweather&family=Source+Sans+Pro&family=Nunito+Sans&display=swap" rel="stylesheet">
    <link id="favicon-link" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🚀</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-image: none;
            --bg-color: #F8F9FA;
            --text-color: #1f2937;
            --text-color-light: #6b7280;
            --primary-color: #D97706;
            --primary-hover-color: #B45309;
            --card-bg-color: rgba(255, 255, 255, 0.6);
            --card-border-color: rgba(0, 0, 0, 0.1);
            --modal-bg-color: rgba(255, 255, 255, 0.9);
            --input-bg-color: rgba(255, 255, 255, 0.8);
            --table-header-bg: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            background-image: var(--bg-image);
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
            color: var(--text-color);
            transition: background-color 0.5s, color 0.5s;
        }
        h1, h2, h3, .font-teko { font-family: 'Teko', sans-serif; letter-spacing: 1px; }

        .text-brand-primary { color: var(--primary-color); }
        .bg-brand-primary { background-color: var(--primary-color); }
        .bg-brand-primary:hover { background-color: var(--primary-hover-color); }
        .accent-brand-primary { accent-color: var(--primary-color); }
        .border-brand-primary { border-color: var(--primary-color); }

        .admin-tab-active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color) !important;
            background-color: rgba(255, 255, 255, 0.05);
        }

        .glass-card {
            background: var(--card-bg-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid var(--card-border-color);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            transition: all 0.3s ease;
        }
        .glass-modal {
            background: var(--modal-bg-color);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 1.5rem;
            border: 1px solid var(--card-border-color);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }

        .main-content {
            background: var(--card-bg-color);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--card-border-color);
        }

        input, select, textarea {
            background-color: var(--input-bg-color) !important;
            color: var(--text-color) !important;
            border-color: var(--card-border-color) !important;
        }
        input::placeholder, textarea::placeholder {
            color: var(--text-color-light) !important;
        }
        input[type="color"] { -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 56px; height: 56px; padding: 0; border: none; border-radius: 50%; cursor: pointer; transition: transform 0.2s; }
        input[type="color"]:hover { transform: scale(1.1); }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 2px solid #e5e7eb; border-radius: 50%; }
        input[type="color"]::-moz-color-swatch { border: 2px solid #e5e7eb; border-radius: 50%; }


        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-recebido { background-color: #3b82f6; color: white; }
        .status-preparo { background-color: #f59e0b; color: white; }
        .status-entrega { background-color: #8b5cf6; color: white; }
        .status-concluido { background-color: #10b981; color: white; }
        .status-cancelado { background-color: #ef4444; color: white; }
    </style>
</head>
<body>

    <div id="app">
        <!-- Tela de Bloqueio/Assinatura -->
        <div v-if="isBlocked" class="fixed inset-0 bg-gray-100 flex flex-col items-center justify-center text-center p-8 z-50">
            <i class="fas fa-exclamation-triangle text-6xl text-amber-500 mb-4"></i>
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Acesso Suspenso</h1>
            <p class="text-lg text-gray-600">Sua assinatura expirou ou o acesso foi bloqueado.</p>
            <a :href="renewalLink" target="_blank" class="mt-6 inline-block bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-all">
                <i class="fab fa-whatsapp mr-2"></i> Renovar Agora
            </a>
        </div>

        <div v-if="isReady && !isBlocked">
            <!-- TELA DE AUTENTICAÇÃO -->
            <div v-if="!isLoggedIn" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
                 <div class="glass-modal p-8 max-w-sm w-full fade-in">
                    <!-- TELA DE LOGIN -->
                    <div v-if="authScreen === 'login'">
                        <h3 class="text-2xl font-bold mb-4 text-center">Acesso ao Painel</h3>
                        <div class="space-y-4">
                            <div><label for="email" class="block text-sm font-medium">Email</label><input type="email" v-model="email" id="email" placeholder="seu@email.com" class="mt-1 w-full p-3 rounded-lg focus:ring-brand-primary focus:border-brand-primary"></div>
                            <div><label for="password" class="block text-sm font-medium">Senha</label><input type="password" v-model="password" @keyup.enter="handleLogin" id="password" placeholder="Sua senha" class="mt-1 w-full p-3 rounded-lg focus:ring-brand-primary focus:border-brand-primary"></div>
                        </div>
                        <p v-if="authError" class="text-red-500 text-sm text-center my-4">{{ authError }}</p>
                        <button @click="handleLogin" class="w-full bg-brand-primary text-white font-bold py-3 rounded-lg shadow-lg mt-4">Entrar</button>
                    </div>
                </div>
            </div>

            <!-- Conteúdo do Painel -->
            <div v-if="isLoggedIn" class="container mx-auto p-4 md:p-8 max-w-7xl fade-in">
                
                <header class="flex justify-between items-start mb-10">
                    <div>
                        <h1 class="text-6xl md:text-7xl font-bold uppercase">Painel de Delivery</h1>
                        <p class="text-sm mt-2">Gerenciando: {{ tenantId }}</p>
                    </div>
                    <button @click="handleLogout" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                        <i class="fas fa-sign-out-alt mr-2"></i>Sair
                    </button>
                </header>
                
                <main class="main-content rounded-2xl shadow-2xl p-6 md:p-10">
                    <div class="mb-6 border-b-2" style="border-color: var(--card-border-color);">
                        <nav class="flex -mb-px flex-wrap">
                            <button @click="adminActiveTab = 'dashboard'" :class="{ 'admin-tab-active': adminActiveTab === 'dashboard' }" class="flex-1 py-3 px-1 text-center font-semibold border-b-4 border-transparent hover:text-brand-primary focus:outline-none rounded-t-lg"><i class="fas fa-chart-line md:mr-2"></i><span class="hidden md:inline">Dashboard</span></button>
                            <button @click="adminActiveTab = 'orders'" :class="{ 'admin-tab-active': adminActiveTab === 'orders' }" class="flex-1 py-3 px-1 text-center font-semibold border-b-4 border-transparent hover:text-brand-primary focus:outline-none rounded-t-lg"><i class="fas fa-receipt md:mr-2"></i><span class="hidden md:inline">Pedidos Ativos</span></button>
                            <button @click="adminActiveTab = 'history'" :class="{ 'admin-tab-active': adminActiveTab === 'history' }" class="flex-1 py-3 px-1 text-center font-semibold border-b-4 border-transparent hover:text-brand-primary focus:outline-none rounded-t-lg"><i class="fas fa-history md:mr-2"></i><span class="hidden md:inline">Histórico</span></button>
                            <button @click="adminActiveTab = 'products'" :class="{ 'admin-tab-active': adminActiveTab === 'products' }" class="flex-1 py-3 px-1 text-center font-semibold border-b-4 border-transparent hover:text-brand-primary focus:outline-none rounded-t-lg"><i class="fas fa-book-open md:mr-2"></i><span class="hidden md:inline">Cardápio</span></button>
                            <button @click="adminActiveTab = 'settings'" :class="{ 'admin-tab-active': adminActiveTab === 'settings' }" class="flex-1 py-3 px-1 text-center font-semibold border-b-4 border-transparent hover:text-brand-primary focus:outline-none rounded-t-lg"><i class="fas fa-cogs md:mr-2"></i><span class="hidden md:inline">Configurações</span></button>
                        </nav>
                    </div>

                    <div class="mt-4 fade-in" :key="adminActiveTab">
                        <!-- ABA DASHBOARD -->
                        <div v-show="adminActiveTab === 'dashboard'">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                                <div class="glass-card p-5 flex items-center"><i class="fas fa-dollar-sign text-3xl text-brand-primary"></i><div class="ml-4"><p class="text-sm">Receita Hoje</p><p class="text-2xl font-bold">R$ {{ dashboardData.revenueToday.toFixed(2) }}</p></div></div>
                                <div class="glass-card p-5 flex items-center"><i class="fas fa-receipt text-3xl text-blue-500"></i><div class="ml-4"><p class="text-sm">Pedidos Hoje</p><p class="text-2xl font-bold">{{ dashboardData.ordersToday }}</p></div></div>
                                <div class="glass-card p-5 flex items-center"><i class="fas fa-concierge-bell text-3xl text-purple-500"></i><div class="ml-4"><p class="text-sm">Ticket Médio</p><p class="text-2xl font-bold">R$ {{ dashboardData.averageTicket.toFixed(2) }}</p></div></div>
                                <div class="glass-card p-5 flex items-center"><i class="fas fa-star text-3xl text-green-500"></i><div class="ml-4"><p class="text-sm">Produto Popular</p><p class="text-lg font-bold">{{ dashboardData.mostPopularProduct || 'N/A' }}</p></div></div>
                            </div>
                            <!-- Gráficos -->
                             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                                <div class="lg:col-span-1 glass-card p-6">
                                    <h3 class="text-lg font-bold mb-4 text-center">Meta Mensal</h3>
                                    <div>
                                        <label class="block text-sm font-medium">Definir Meta (R$)</label>
                                        <div class="mt-1 flex rounded-md shadow-sm">
                                            <span class="inline-flex items-center px-3 rounded-l-md border border-r-0">R$</span>
                                            <input type="number" v-model.number="settings.monthlyGoal" @change="saveSettings" class="w-full p-2 border rounded-r-md" placeholder="5000.00">
                                        </div>
                                    </div>
                                    <p class="text-center text-sm mt-2">Faturamento: R$ {{ dashboardData.thisMonthRevenue.toFixed(2) }} / R$ {{ (settings.monthlyGoal || 0).toFixed(2) }}</p>
                                </div>
                                <div class="lg:col-span-2 glass-card p-6">
                                    <h3 class="text-lg font-bold mb-4">Desempenho da Semana</h3>
                                     <div class="flex items-end border-l border-b h-64 pl-4 pb-4">
                                        <div v-for="(dayData, day) in dashboardData.weeklyPerformance" :key="day" class="flex-1 flex flex-col items-center justify-end h-full mx-1">
                                            <p class="text-xs font-semibold">R${{ dayData.revenue.toFixed(0) }}</p>
                                            <div class="w-3/4 bg-amber-300/80 rounded-t-md hover:bg-amber-400" :style="{ height: dayData.percentage + '%' }"></div>
                                            <p class="text-sm font-bold mt-1">{{ day }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ABA PEDIDOS ATIVOS -->
                        <div v-show="adminActiveTab === 'orders'">
                            <!-- ... (código existente da aba de pedidos) ... -->
                        </div>
                        
                        <!-- ABA HISTÓRICO -->
                        <div v-show="adminActiveTab === 'history'">
                            <h3 class="text-xl font-bold mb-4">Histórico de Pedidos</h3>
                            <div v-if="historyOrders.length === 0" class="text-center p-6 glass-card"><i class="fas fa-history fa-2x mb-3"></i><p>Nenhum pedido no histórico.</p></div>
                             <div v-else class="space-y-4">
                                <!-- (Semelhante à aba de pedidos, mas para `historyOrders`) -->
                            </div>
                        </div>

                        <!-- ABA CARDÁPIO (PRODUTOS) -->
                        <div v-show="adminActiveTab === 'products'">
                            <!-- ... (código existente da aba de produtos) ... -->
                        </div>

                        <!-- ABA CONFIGURAÇÕES -->
                        <div v-show="adminActiveTab === 'settings'">
                             <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                                <div class="space-y-8">
                                     <!-- Bloco de Configurações de Delivery -->
                                    <div>
                                        <h3 class="text-xl font-bold mb-4">Configurações de Delivery</h3>
                                        <div class="glass-card p-6 space-y-4">
                                            <!-- ... (código existente) ... -->
                                            <div>
                                                <label class="block text-sm font-medium">Intervalos (Ex: Pausa)</label>
                                                <div v-for="(br, index) in settings.businessHours.breaks" :key="index" class="flex items-center gap-2 mt-2">
                                                    <input type="time" v-model="br.start" class="w-full p-2 border rounded-md">
                                                    <span>até</span>
                                                    <input type="time" v-model="br.end" class="w-full p-2 border rounded-md">
                                                    <button @click="removeBreak(index)" class="text-red-500 p-2"><i class="fas fa-trash"></i></button>
                                                </div>
                                                 <button @click="addBreak" class="text-sm text-blue-600 hover:underline mt-2">+ Adicionar intervalo</button>
                                            </div>
                                            <button @click="saveSettings" class="w-full bg-brand-primary text-white font-bold py-2 rounded-lg">Salvar Configurações</button>
                                        </div>
                                    </div>
                                     <!-- Bloco de Perfil e Redes Sociais -->
                                    <div>
                                        <h3 class="text-xl font-bold mb-4">Perfil e Redes Sociais</h3>
                                        <!-- ... (código existente) ... -->
                                    </div>
                                     <!-- Bloco de Horários Especiais -->
                                    <div>
                                        <h3 class="text-xl font-bold mb-4">Horários Especiais</h3>
                                         <!-- (formulário para adicionar datas especiais) -->
                                    </div>
                                </div>
                                <div class="space-y-8">
                                     <!-- Bloco de Aparência -->
                                    <div>
                                        <h3 class="text-xl font-bold mb-4">Aparência da Página</h3>
                                        <div class="glass-card p-6 space-y-4">
                                            <!-- (código de aparência completo restaurado aqui) -->
                                        </div>
                                    </div>
                                     <!-- Bloco da Galeria -->
                                    <div>
                                        <h3 class="text-xl font-bold mb-4">Galeria de Fotos (Máx. 4)</h3>
                                        <div class="glass-card p-6 space-y-4">
                                            <!-- (formulário e lista da galeria aqui) -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
        
        <!-- Modais -->
        <!-- ... (código de modais existente) ... -->
    </div>

    <script src="../firebase-config.js"></script>

    <script type="module">
        import { createApp, ref, onMounted, computed } from 'https://unpkg.com/vue@3.4.21/dist/vue.esm-browser.js';
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, doc, getDoc, setDoc, updateDoc, deleteDoc, addDoc, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        if (typeof window.firebaseConfig === 'undefined' || !window.firebaseConfig.apiKey) {
            console.error("Erro Crítico: Configuração do Firebase não encontrada.");
        } else {
            const app = initializeApp(window.firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            createApp({
                setup() {
                    // --- STATE ---
                    const isLoggedIn = ref(false);
                    const email = ref('');
                    const password = ref('');
                    const authError = ref('');
                    const adminActiveTab = ref('orders');
                    const tenantId = ref(null);
                    const isReady = ref(false);
                    const isBlocked = ref(false);
                    const renewalLink = ref('');

                    const orders = ref([]);
                    const products = ref([]);
                    const gallery = ref([]);
                    const newGalleryItem = ref({ imageUrl: '', description: '' });
                    
                    const settings = ref({ 
                        deliveryFee: 5.0,
                        monthlyGoal: 5000,
                        businessHours: { start: '18:00', end: '23:00', breaks: [] }
                    });
                    const profileSettings = ref({ instagram: '', facebook: '', whatsapp: '', address: '', googleMapsEmbed: '' });
                    const appearance = ref({ 
                        title: '', 
                        subtitle: '',
                        primaryColor: '#D97706',
                        backgroundColor: '#F8F9FA',
                        cardBackgroundColor: '#FFFFFF',
                        textColor: '#1f2937',
                        backgroundImageUrl: '',
                        // (outras propriedades de aparência)
                    });

                    const newProduct = ref({ title: '', description: '', imageUrl: '', category: '', price: 0 });
                    const editingProductId = ref(null);
                    
                    const orderStatusFilter = ref('active'); // 'active' ou 'history'

                    const showDeleteModal = ref(false);
                    const itemToDelete = ref({ id: null, type: null });
                    const showFeedbackModal = ref(false);
                    const feedbackModal = ref({ title: '', message: '', icon: '', color: '' });

                    // --- HANDLERS ---
                    const handleLogin = async () => {
                        authError.value = '';
                        if (!email.value || !password.value) { authError.value = 'Preencha e-mail e senha.'; return; }
                        try {
                            await signInWithEmailAndPassword(auth, email.value, password.value);
                        } catch (error) {
                            authError.value = 'E-mail ou senha inválidos.';
                        }
                    };
                    const handleLogout = async () => { await signOut(auth); };
                    
                    const openFeedbackModal = (title, message, icon, color) => {
                        feedbackModal.value = { title, message, icon, color };
                        showFeedbackModal.value = true;
                    };

                    const fetchAdminData = () => {
                        if (!tenantId.value) return;
                        onSnapshot(query(collection(db, `tenants/${tenantId.value}/orders`), orderBy("createdAt", "desc")), s => { orders.value = s.docs.map(d=>({id:d.id, ...d.data()}))});
                        onSnapshot(query(collection(db, `tenants/${tenantId.value}/products`)), s => { products.value = s.docs.map(d=>({id:d.id, ...d.data()}))});
                        onSnapshot(query(collection(db, `tenants/${tenantId.value}/gallery`)), s => { gallery.value = s.docs.map(d=>({id:d.id, ...d.data()}))});
                        onSnapshot(doc(db, `tenants/${tenantId.value}/config/delivery`), s => { if(s.exists()) settings.value = {...settings.value,...s.data()}});
                        onSnapshot(doc(db, `tenants/${tenantId.value}/config/profile`), s => { if(s.exists()) profileSettings.value = {...profileSettings.value,...s.data()}});
                        onSnapshot(doc(db, `tenants/${tenantId.value}/config/appearance`), s => { if(s.exists()) appearance.value = {...appearance.value, ...s.data()}});
                    };

                    const addOrUpdateProduct = async () => { /* ... (código existente) ... */ };
                    const editProduct = (product) => { /* ... (código existente) ... */ };
                    const cancelEditProduct = () => { /* ... (código existente) ... */ };

                    const promptDelete = (id, type) => { itemToDelete.value = { id, type }; showDeleteModal.value = true; };
                    const confirmDelete = async () => { /* ... (código de exclusão adaptado) ... */ };

                    const saveSettings = async () => { /* ... */ };
                    const saveProfileSettings = async () => { /* ... */ };
                    const saveAppearance = async () => { /* ... */ };
                    const addGalleryItem = async () => { /* ... */ };
                    const addBreak = () => { if (!settings.value.businessHours.breaks) settings.value.businessHours.breaks = []; settings.value.businessHours.breaks.push({start: '', end: ''}); };
                    const removeBreak = (index) => { settings.value.businessHours.breaks.splice(index, 1); };


                    const updateOrderStatus = async (order, newStatus) => { /* ... (código existente) ... */ };

                    // --- COMPUTED ---
                    const activeOrders = computed(() => {
                        const activeStatus = ['recebido', 'preparo', 'entrega'];
                        return orders.value.filter(order => activeStatus.includes(order.status));
                    });
                    
                    const historyOrders = computed(() => {
                        const historyStatus = ['concluido', 'cancelado'];
                        return orders.value.filter(order => historyStatus.includes(order.status));
                    });
                    
                    const dashboardData = computed(() => { /* ... (código do dashboard existente) ... */ });

                    // --- LIFECYCLE ---
                    onMounted(() => {
                        // ... (código onMounted para obter tenantId e verificar auth)
                    });

                    return {
                        // ... (retorno completo de todas as refs e funções)
                    };
                }
            }).mount('#app');
        }
    </script>
</body>
</html>

